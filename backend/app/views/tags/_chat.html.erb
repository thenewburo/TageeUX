<%= content_tag(:div, '', :'data-messages-url' => tag_messages_url(@tag)) %>
<script>
  window.loggedIn = <%= current_user.present?.to_json %>;
</script>
<div class="row chatroom" ng-app="tagee" ng-controller="ChatCtrl">
  <div class="row column text-center"></div>

  <div class="large-2 columns ">
    <div class="panel">
      <% if current_user %>
        <%= image_tag current_user.avatar_url, class: "thumbnail big" %>
      <% else %>
        <img src="http://placehold.it/150x150&text=User Avatar"/>
      <% end %>

      <h5>
        <a href="#">{{ users.length | number }} Tagees</a>
      </h5>
      <div class="section-container vertical-nav" data-options="deep_linking: false; one_up: true" data-section></div>

    </div>
  </div>

  <div class="large-7 columns">
    <div class="messages">
    <div class="media-object stack-for-small" ng-repeat="message in messages"
      ng-class="{ 'flow-right': $index % 2 == 1 }">
      <div class="media-object-section thumbnail-container">
        <img class="thumbnail tiny" ng-src="{{ message.avatar_url }}" />
      </div>
      <div class="media-object-section chat-message">
        <h5 class="text tiny">
          {{ message.login }}
          <small>
            {{ message.created_at | date:'MMM d, yyyy - h:m:ss' }}
          </small>
        </h5>
        <p class="text tiny" ng-bind-html="message.body | colonToSmiley"></p>
      </div>
      <hr class="tiny">
    </div>
  </div>
  <% if current_user %>
    <div emoji-form emoji-message="emojiMessage" ng-keydown="keyDown($event)">
      <textarea maxlength="350" ng-model="emojiMessage.messagetext" type="text"></textarea>
      <button id="emojibtn">
        <i class="icon icon-emoji"></i>
      </button>
      <span class="char-count" ng-class="{ 'too-many-chars': tooManyChars() }">
        <span ng-bind-html="charsLeft()"></span>
      </span>
    </div>
    <button class="button expanded" ng-click="submitMessage()">Submit</button>
  <% else %>
    <div>
      <p class='text-center'>
        <a href data-open="login_signup">Login now</a> to chat about #<%= @tag.title %>
      </p>
    </div>
  <% end %>

  </div>

  <aside class="large-3 columns hide-for-small">
    <%= form_for :user_tag_category, url: user_tag_categories_path do |f| %>
      <label>Choose your TAGspot topic.
        <br/>
        <%= f.select :tag_categories_ids, tag_categories_for_select(@user_tag_categories, @tag), { include_blank: false }, { multiple: true, size: TagCategory.count, data: { multiple: nil } } %>
        <%= f.hidden_field :tag_id, value: @tag.id %>
        <%= f.submit 'Save' %>
      </label>
    <% end %>
    <!-- <p><img src="http://placehold.it/300x440&text=[ad]"/></p> -->
  </aside>

</div>
<hr/>
